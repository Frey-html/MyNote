在 RISC-V 流水线 CPU 中，中断（interrupt）和异常（exception）是处理器在执行程序过程中遇到的两种特殊事件。它们可以打断正常的指令执行流程，强制 CPU 跳转到特定的服务例程来处理事件。中断通常由外部硬件设备触发，而异常则是在 CPU 内部执行过程中由于错误或特定情况触发。处理这两类事件需要特定的机制，**CSR（Control and Status Register）**在其中起到了重要的作用。
### 中断处理[¶](https://note.tonycrane.cc/cs/pl/riscv/privileged/#_4 "Permanent link")

RISC-V 中外部中断必须通过 CSR 来开启，开启中断由两个步骤：

- mstatus[MIE] 是全局中断使能位，设置为 1 才会全局开启中断
- mie 寄存器中是针对各种中断类型的使能位，要将需要的位设置为 1

中断响应程序的入口地址由 mtvec 寄存器指定，如前面写到的，它分为两种模式：

- 直接模式（Direct），所有 trap 都跳转到 mtvec 寄存器指定的地址进行处理
- 向量化模式（Vectored），中断将根据中断类型跳转到不同偏移位置的中断响应程序，异常仍使用同一个响应程序

当中断发生时，CPU 会：

- 将发生异常的指令（或下一条指令）的地址保存到 mepc 寄存器
- 将中断类型码保存到 mcause 寄存器
- 如果中断带有附加信息，将其保存到 mtval 寄存器
- 如果是外部引发的中断，令 mstatus[MPIE] = mstatus[MIE]（保存），然后令 mstatus[MIE] = 0（关闭中断）
- 将当前特权模式保存到 mstatus[MPP] 中
- 将当前特权模式设置为 Machine 模式
- 根据 mtvec 寄存器的设置，跳转到对应中断响应程序

中断处理结束后要使用 mret 指令进行返回，它会：

- 令 mstatus[MIE] = mstatus[MPIE]（恢复），然后令 mstatus[MPIE] = 1
- 将当前特权模式设置为 mstatus[MPP] 中保存的值
- 将 mstatus[MPP] 设置为 U 模式
- 将 pc 值设置为 mepc 值，即跳转回中断前的程序


### 一、RISC-V 流水线 CPU 的中断与异常

1. **中断（Interrupt）**：
   - 中断是一种异步事件，通常由外部设备触发，例如定时器中断、I/O 设备请求等。中断会在指令执行的某个时刻打断流水线，跳转到一个中断处理程序。
   - 中断分为**硬件中断**（例如外部设备产生的中断）和**软件中断**（如操作系统发起的中断）。

2. **异常（Exception）**：
   - 异常是同步事件，是在指令执行过程中由于 CPU 本身的操作或状态错误引发的。典型的异常包括非法指令、页错误（Page Fault）、访问未对齐的内存等。
   - 异常一般发生在指令执行的某个具体阶段，比如访存阶段时，检测到地址非法或者没有权限访问，就会引发异常。

### 二、中断与异常的检测与处理

#### 1. **流水线中的检测**
在一个 RISC-V 的流水线 CPU 中，各个流水线阶段可以检测异常或中断请求：

- **取指阶段（Fetch Stage）**：如果取指过程中遇到页错误，可能会触发异常。
- **解码阶段（Decode Stage）**：在解码阶段，如果指令无效（例如不支持的操作码），则会产生非法指令异常。
- **执行阶段（Execute Stage）**：在执行阶段，某些指令执行过程中可能触发异常，例如除零异常。
- **访存阶段（Memory Stage）**：在访存阶段，如果访问的地址没有映射，或者权限不允许访问，则会引发页错误异常。
- **写回阶段（Write Back Stage）**：一般不会有新的异常产生，但可能需要处理中断。

中断是**异步事件**，因此它可以在流水线的任意阶段发生。处理器通常会在某个安全的时刻，比如**流水线空闲或指令执行完成**后，处理中断请求。大多数情况下，处理器会选择在指令的提交阶段（写回阶段）处理中断请求，以确保在处理中断前，前面的指令都已正确完成执行。

#### 2. **异常与中断的处理流程**

处理异常和中断的步骤大致如下：

1. **异常/中断检测**：在各个流水线阶段检查异常条件，并检测外部硬件中断信号。
2. **流水线清空**：一旦检测到需要处理异常或中断，处理器会**清空流水线**，防止未提交的指令继续执行。所有后续的指令被丢弃。
3. **保存上下文**：处理器需要保存当前执行状态（包括 PC、寄存器状态），以便在处理完异常或中断后，能够返回继续执行。此时，CSR（Control and Status Registers）中的一些寄存器用于保存上下文信息：
   - **`mepc`**（Machine Exception Program Counter）：保存引发异常或中断的指令地址。
   - **`mcause`**：保存引发异常或中断的原因。
   - **`mtval`**：保存异常相关的额外信息（如错误的地址）。
4. **切换到异常/中断处理程序**：处理器跳转到异常或中断向量表中的指定地址，并开始执行相应的服务例程。
5. **恢复执行**：处理完异常或中断后，恢复保存的上下文，并从保存的 `mepc` 寄存器中的地址继续执行被中断的程序。

### 三、CSR（Control and Status Registers）在中断和异常中的作用

RISC-V 架构使用一系列**控制和状态寄存器（CSR）**来管理中断和异常。这些寄存器在中断/异常的处理过程中起到关键作用，主要有以下几类：

1. **异常和中断状态寄存器**：
   - **`mstatus`（Machine Status Register）**：保存处理器当前的状态信息，包括中断使能位、特权级等。
     - **`MIE`**：全局机器级中断使能位，控制是否允许处理器响应中断。
     - **`MPIE`**：中断时保存全局中断使能状态。
   - **`mip`（Machine Interrupt Pending Register）**：记录挂起的中断类型。它的每一位对应不同类型的中断，例如外部中断、软件中断、定时器中断等。
   - **`mie`（Machine Interrupt Enable Register）**：用于配置允许响应的中断类型，与 `mip` 结合使用。`mie` 的每一位对应一个中断类型，允许或屏蔽特定的中断。

2. **异常处理相关寄存器**：
   - **`mepc`（Machine Exception Program Counter）**：当异常或中断发生时，处理器会将导致异常或中断的指令地址保存到 `mepc` 寄存器中，以便处理完成后从该指令继续执行。
   - **`mcause`（Machine Cause Register）**：保存触发异常或中断的原因。`mcause` 的低位表示异常或中断的编码，高位表示是中断（1）还是异常（0）。
   - **`mtval`（Machine Trap Value Register）**：用于保存异常相关的信息。例如，当一个加载或存储异常发生时，`mtval` 可以保存导致异常的内存地址。

3. **中断向量表**：
   - **`mtvec`（Machine Trap-Vector Base-Address Register）**：保存中断或异常处理程序的入口地址。当发生异常或中断时，处理器会跳转到 `mtvec` 寄存器指定的地址开始执行异常/中断处理程序。

#### **CSR 在中断处理中的流程**

1. **触发中断/异常**：当流水线 CPU 检测到中断或异常时，将立即清空流水线，防止正在执行的指令继续。
   
2. **保存状态**：CPU 会将当前执行的指令地址（PC）保存到 `mepc` 寄存器中，以便中断/异常处理结束后返回。`mcause` 用于记录中断或异常的原因，`mtval` 则保存更多与异常相关的具体信息，如导致异常的内存地址。

3. **处理程序跳转**：处理器根据 `mtvec` 寄存器中的地址，跳转到相应的中断或异常处理程序。

4. **返回用户程序**：中断处理结束后，CPU 从 `mepc` 寄存器中恢复之前保存的 PC 值，继续执行被中断的程序。此时，`mstatus` 中的 `MPIE` 会恢复原先的中断状态。

### 四、流水线 CPU 中中断/异常的特殊处理

在流水线 CPU 中，中断和异常的处理还会带来一些流水线相关的问题：

1. **指令乱序提交**：在超标量或乱序执行的 CPU 中，指令执行顺序可能并非严格按照程序顺序。如果异常或中断发生在某个指令后，但此时之前的指令尚未提交，CPU 需要确保在提交异常之前，所有早于异常的指令都已经正确完成。

2. **回滚与恢复**：当异常或中断发生时，流水线可能已经执行了一些指令，但这些指令尚未提交。处理器需要清空这些未提交的指令，并回滚到异常发生时的状态。

3. **异常优先级**：在复杂的系统中，可能会同时发生多个异常或中断。处理器需要有一个机制来判断哪个异常或中断具有更高的优先级。例如，定时器中断可能比软件中断优先级更高，因此处理器首先处理定时器中断。

### 五、总结

- **中断**是外部硬件触发的异步事件，**异常**是 CPU 执行过程中由于错误或特定条件触发的同步事件。
- RISC-V 的流水线 CPU 在不同阶段检测中断和异常信号，并通过一系列步骤清空流水线、保存上下文、跳转到处理程序以及恢复执行。
- **CSR**在中断和异常处理中扮演了关键角色，保存了处理器的上下文信息，并提供了中断和异常处理的相关配置寄存器。
- 在流水线 CPU 中，处理中断和异常时需要特别

注意流水线状态的回滚、指令提交顺序以及多种中断/异常的优先级管理。