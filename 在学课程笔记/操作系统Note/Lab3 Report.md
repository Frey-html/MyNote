### 浙江大学实验报告
---
课程名称：操作系统
实验项目名称：RV64 虚拟内存管理
学生姓名：展翼飞  学号：3190102196
电子邮件地址：1007921963@qq.com
实验日期： 2024年 10 月 30 日
### 一、实验内容
#### 1. 准备工程
* 使用`git fetch`与`git merge`从仓库同步`lab3 vmlinux.lds`代码，并从`lab2`拷贝之前完成的代码![[Pasted image 20241029164503.png]]
* 在`defs.h`中添加本实验虚拟内存相应的宏定义![[Pasted image 20241029164655.png]]
* 修改根目录`Makefile`的`ISA`，支持指令屏障，使用刷新缓存的指令扩展![[Pasted image 20241029165112.png]]
#### 2.PIE
* 因为 GOT 表里的地址都是最终的虚拟地址，所以在 kernel 启用虚拟地址之前，一切从 GOT 表取出的地址都是错的，这种情况下需要手动给 `la` 得到的地址减去 `PA2VA_OFFSET` 才能得到正确的物理地址。
	为了避免这种情况，需要在 Makefile 的 `CF` 中加一个 `-fno-pie` 强制不编译出 PIE 的代码![[Pasted image 20241029165522.png]]

#### 3.开启虚拟内存映射

##### 3.1 `setup_vm` 的实现


##### 3.2 `setup_vm_final` 的实现



#### 4.编译与测试

### 二、思考题
1. 验证 `.text`，`.rodata` 段的属性是否成功设置，给出截图。
2. 为什么我们在 `setup_vm` 中需要做等值映射？在 Linux 中，是不需要做等值映射的，请探索一下不在 `setup_vm` 中做等值映射的方法。你需要回答以下问题：
    
    - 本次实验中如果不做等值映射，会出现什么问题，原因是什么；
    - 简要分析 [Linux v5.2.21](https://elixir.bootlin.com/linux/v5.2.21/source) 或之后的版本中的内核启动部分（直至 `init/main.c` 中 `start_kernel` 开始之前），特别是设置 satp 切换页表附近的逻辑；
    - 回答 Linux 为什么可以不进行等值映射，它是如何在无等值映射的情况下让 pc 从物理地址跳到虚拟地址；
    - Linux v5.2.21 中的 `trampoline_pg_dir` 和 `swapper_pg_dir` 有什么区别，它们分别是在哪里通过 satp 设为所使用的页表的；
    - 尝试修改你的 kernel，使得其可以像 Linux 一样不需要等值映射。



### 三、问题与心得
