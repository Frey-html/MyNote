在 RISC-V 的内核启动过程中，如果不进行等值映射，内核在跳转到虚拟地址空间后无法正确访问内存，导致系统无法正常运行。在 RISC-V 的 Linux 启动流程中，内核采用特殊的启动流程来避免等值映射，直接从物理地址空间跳转到虚拟地址空间。以下是问题的详细分析。

### 1. 如果不做等值映射会出现什么问题？原因是什么？

如果不进行等值映射，那么在 `setup_vm` 函数完成设置页表并切换页表后，虚拟地址将不再直接映射到物理地址空间。由于 CPU 的程序计数器（PC）指向的是虚拟地址，缺少等值映射会导致 PC 指向的地址和物理内存地址不一致，导致内核代码和数据无法正确加载和运行，导致系统崩溃或启动失败。

具体来说，当在 RISC-V 架构上设置 `satp` 切换到虚拟地址模式时，PC 的地址必须有一个有效的页表映射才能正确执行指令。如果没有建立等值映射，内核一开始就会在虚拟地址上找不到映射到的物理地址，无法完成初始化。

### 2. Linux v5.2.21 内核启动过程分析

在 Linux 内核版本 5.2.21 或之后，启动过程经过了以下步骤，最终在 `init/main.c` 的 `start_kernel` 函数中正式启动内核。在此过程中，内核避免了等值映射的需要，具体步骤如下：

1. **从引导程序（bootloader）加载内核**：Linux 的引导程序将内核加载到一个物理地址（例如 0x80000000）。
2. **设置 trampoline_pg_dir**：Linux 内核首先使用一个最小的页表（`trampoline_pg_dir`）进行短暂的页表切换，这是一个简单的跳板页表，仅仅包含从物理地址到虚拟地址的临时映射。
3. **跳转到虚拟地址**：使用 `trampoline_pg_dir` 后，内核将 PC 设置到高地址虚拟地址空间（例如 0xffffffff80000000），并将页表切换到 `swapper_pg_dir`。
4. **`start_kernel` 函数**：在正确映射了内核空间后，内核开始在虚拟地址空间中运行，`start_kernel` 负责完成后续初始化。

### 3. 为什么 Linux 不需要等值映射

Linux 不进行等值映射是因为它使用了一个分阶段的页表切换机制，先将物理地址短暂映射到虚拟地址空间，并在完成跳转后释放该映射。主要原因如下：

1. **短暂使用 trampoline_pg_dir**：Linux 内核首先利用 `trampoline_pg_dir` 页表，短暂地将物理内核地址映射到虚拟地址空间，使得 PC 可以从物理地址跳转到虚拟地址。
2. **在虚拟地址上设置正式页表**：内核切换到 `swapper_pg_dir` 后，PC 的指令执行和内存访问都基于虚拟地址，且不需要等值映射。

通过这种机制，Linux 在内核正式启动前，快速完成从物理地址到虚拟地址的过渡，避免了等值映射。

### 4. `trampoline_pg_dir` 和 `swapper_pg_dir` 的区别

- **`trampoline_pg_dir`**：这是一个临时的页表，用于在内核跳转到虚拟地址空间前进行的短暂映射。它包含了物理地址到虚拟地址的临时映射，保证 CPU 能够正确跳转到高位虚拟地址空间。
- **`swapper_pg_dir`**：这是 Linux 内核的正式页表，在内核切换到虚拟地址空间后，`swapper_pg_dir` 被设为 `satp` 寄存器的页表基址，它包含了完整的内核虚拟内存映射。

`trampoline_pg_dir` 通常是在内核启动前初始化，并在切换到 `swapper_pg_dir` 后释放。`swapper_pg_dir` 则在 `start_kernel` 之前被加载到 `satp` 寄存器，使内核从此后在虚拟地址空间中执行。

### 5. 修改内核以避免等值映射

要修改实验内核实现类似 Linux 的无等值映射启动，可以参考以下方法：

1. **创建临时页表**：类似 `trampoline_pg_dir`，在物理地址中创建一个简单的页表，仅映射用于跳转的几个关键内存页。
2. **设置跳板页表**：在加载页表后，将 `satp` 寄存器指向 `trampoline_pg_dir`，并设置 PC 到高位虚拟地址空间（例如 `0xffffffff80000000`）。
3. **切换到正式页表**：在跳转到高地址虚拟空间后，设置 `swapper_pg_dir` 为 `satp`，并释放 `trampoline_pg_dir`。
4. **启动主内核代码**：在 `setup_vm` 中进行正式的页表配置，使内核能够在虚拟地址空间中访问所需的内存区域。

通过此流程，我们可以在不进行等值映射的情况下，成功从物理地址切换到虚拟地址并完成内核启动。