在 RISC-V 架构中，线程切换时只保存部分寄存器（如 `ra`、`sp` 和 `s0-s11`），这是为了在保证上下文切换正确性的前提下，减少保存和恢复寄存器的开销。接下来我们详细解释为什么选择保存这些寄存器。

### RISC-V 寄存器分类

RISC-V 架构的寄存器可以分为以下几类：

1. **临时寄存器** (`t0-t6`)：这些寄存器是用来存放临时数据的，不要求在函数调用间保持数据不变。如果在函数调用过程中使用了这些寄存器，调用者负责保存和恢复这些寄存器。
   
2. **保存寄存器** (`s0-s11`)：这些寄存器在函数调用间要保持不变，任何一个函数如果修改了这些寄存器，必须在退出时恢复原值。这些寄存器的数据在上下文切换时需要保存。

3. **返回地址寄存器** (`ra`)：存放函数返回地址。当函数调用时，跳转到子函数后会自动保存调用者的返回地址，在线程切换时也需要保存它，以便切换回来时可以继续执行。

4. **栈指针寄存器** (`sp`)：指向栈的顶部，函数调用时需要使用栈来保存局部变量和返回地址等。线程切换时需要保存它，以便恢复栈的状态。

5. **程序计数器（`pc`）**：指向即将执行的指令的地址。在中断或异常处理时，系统会自动保存和恢复 `pc`，但在线程切换时，不需要单独手动保存 `pc`，因为恢复 `ra` 和 `sp` 后，程序会从正确的地方继续执行。

### 为什么只保存 `ra`、`sp` 和 `s0-s11`？

1. **`s0-s11` 保存寄存器**：  
   在 RISC-V 中，`s0-s11` 是调用者保存寄存器，这意味着调用函数不会改变这些寄存器的值，除非该函数显式修改并在返回前恢复。为了在线程切换后保持上下文一致，这些寄存器必须保存并在切换回来时恢复，否则函数调用之间会失去重要的数据。

2. **`ra` 返回地址寄存器**：  
   `ra` 保存着函数的返回地址，线程切换时如果不保存 `ra`，当恢复线程后执行的指令可能错误。因此，必须保存 `ra`，以确保线程切换后能正确返回到之前的执行位置。

3. **`sp` 栈指针寄存器**：  
   `sp` 维护栈的状态，函数调用时会使用栈来保存局部变量、返回地址等。如果不保存 `sp`，线程切换回来时栈的状态会丢失，导致函数调用链出错，甚至程序崩溃。因此，`sp` 也是必须保存的。

### 为什么不保存其他寄存器？

- **临时寄存器 `t0-t6`**：  
  临时寄存器 (`t0-t6`) 是调用者负责保存的寄存器，它们的内容在函数调用后可以自由被修改。因为函数在调用其他子函数时，已经假设这些寄存器的内容可能被破坏，所以不需要在线程切换时保存它们。保存这些寄存器会带来不必要的开销，而不保存它们对程序的正确性没有影响。

- **`a0-a7` 参数寄存器**：  
  这些寄存器用于传递函数参数和返回值，类似于临时寄存器，它们的内容在函数调用之后通常会被覆盖或重新赋值，因此在线程切换时不需要保存这些寄存器。

- **程序计数器 `pc`**：  
  程序计数器 `pc` 指向当前正在执行的指令，但由于 `ra` 已经保存了函数的返回地址，恢复 `ra` 后会自动恢复执行位置，所以没有必要单独保存 `pc`。只要 `ra` 和 `sp` 保存正确，程序切换回来后就能继续从正确的地方执行。

### 线程切换时保存最少的上下文

线程切换是一个频繁发生的操作，保存和恢复寄存器的操作是有开销的。为了优化上下文切换的性能，操作系统只保存那些必须保证不变的寄存器（`ra`、`sp`、`s0-s11`），而不保存临时寄存器等可以丢弃的数据。

通过只保存必要的寄存器，RISC-V 架构能够减少线程切换的开销，提高系统的性能，同时保证线程切换的正确性。

### 总结

- **保存 `ra`**：确保线程切换后能从正确的地方继续执行。
- **保存 `sp`**：恢复栈的状态，保证函数调用链的正确性。
- **保存 `s0-s11`**：确保函数调用过程中使用的保存寄存器保持一致。
- **不保存 `t0-t6`** 和 `a0-a7`** ：这些寄存器在函数调用后通常被重新赋值或可以丢弃，因此不必保存，减少了上下文切换的开销。