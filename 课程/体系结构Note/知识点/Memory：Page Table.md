参考资料：[计算机组成原理：简单页表和多级页表（虚拟内存的映射）](https://blog.csdn.net/zhizhengguan/article/details/121276581)
### 页表（Page Table）概述

**页表（Page Table）** 是操作系统用于实现虚拟内存（Virtual Memory）管理的关键数据结构。它将程序的虚拟地址（Virtual Address）映射到物理内存中的实际地址（Physical Address）。通过页表，系统能够有效地管理内存分配和地址转换，使得每个进程可以认为自己拥有连续的虚拟内存空间，而实际物理内存可以分散存储，甚至部分数据可以在硬盘或其他外存中。

虚拟内存通过**分页（Paging）** 技术来管理，虚拟地址空间和物理地址空间都被划分成固定大小的块，称为**页（Page）** 和**页框（Page Frame）**，页表则记录了虚拟页与物理页框之间的映射关系。

### 页表的基本工作原理

1. **虚拟地址**：当 CPU 执行程序时，访问的都是虚拟地址。虚拟地址被分为两部分：
   - **页号（Page Number）**：标识该虚拟地址所属的页。
   - **页内偏移量（Page Offset）**：标识该地址在页内的具体偏移位置。
2. **页表查找**：操作系统会为每个进程维护一个页表，页表中的每一项记录了虚拟页与物理页框的映射。当访问虚拟地址时，CPU 使用虚拟地址中的页号查找对应的物理页框号，并将其与页内偏移量组合，形成物理地址。
3. **页表项（Page Table Entry, PTE）**：页表中的每一项称为页表项，记录了页号和页框号的映射，同时还包括一些控制信息（如是否有效、是否在内存、读写权限等）。

### 页表的结构

由于虚拟内存地址空间通常比物理内存空间大得多，为了高效管理，现代计算机系统通常不直接使用单层页表，而采用多级页表或其他优化技术来减少内存开销。常见的页表结构有以下几种：

#### 1. **单级页表（Single-level Page Table）**
在早期系统或小型嵌入式系统中，使用简单的单级页表。单级页表为每个虚拟页号提供一个直接映射到物理页框的条目。页表项通常存储以下信息：
- **物理页框号**：该虚拟页对应的物理页框的编号。
- **有效位（Valid Bit）**：指示该页是否有效。如果该位为无效，表示该页可能未被加载到内存。
- **访问权限位**：表示该页的读写权限，防止非法访问。
- **脏位（Dirty Bit）**：标记该页是否被修改，未修改的页可以直接丢弃，不必写回硬盘。
![[Pasted image 20240923121840.png]]
##### 优缺点：
- **优点**：实现简单，地址转换速度快（只需一次页表查找）。
- **缺点**：对于 64 位系统或大内存应用程序，单级页表可能过于庞大，存储页表本身的内存开销较高。

#### 2. **多级页表（Multi-level Page Table）**
为了解决单级页表过大的问题，现代操作系统通常采用**多级页表**，例如**二级页表（Two-level Page Table）**、**三级页表** 或 **四级页表**。多级页表通过将虚拟地址空间划分为多个层次，减少页表的存储开销。

##### 多级页表的工作原理：
- **虚拟地址划分**：虚拟地址分为多个部分，分别用于不同级别页表的索引。例如，在二级页表中，虚拟地址可以分为：
  1. **一级页表索引**：用来查找一级页表的条目。
  2. **二级页表索引**：用来查找二级页表的条目。
  3. **页内偏移量**：用于确定数据在物理页框内的位置。
- **逐级查找**：当访问虚拟地址时，首先在一级页表中查找得到二级页表的位置，然后在二级页表中查找物理页框的编号。最后结合页内偏移量形成物理地址。

##### 多级页表结构示意图：
```
虚拟地址结构:
| 一级页表索引 | 二级页表索引 | 页内偏移量 |

多级页表查找流程:
虚拟地址 -> 一级页表 -> 二级页表 -> 物理页框号 -> 物理地址
```
![[Pasted image 20240923121902.png]]
##### 优缺点：
- **优点**：减少了页表所需的内存空间，因为仅需为实际使用的虚拟地址分配页表。未使用的地址空间无需页表条目，节省内存。
- **缺点**：地址转换速度较慢，因为多级页表需要进行多次内存访问来完成虚拟地址到物理地址的映射。

#### 3. **倒排页表（Inverted Page Table）**
倒排页表是为了解决大规模虚拟地址空间的问题，尤其是在 64 位系统中。与普通页表不同，倒排页表基于物理内存页框而不是虚拟地址进行管理。

##### 工作原理：
- 倒排页表中的每一项对应一个物理页框，而不是一个虚拟页。每个条目记录了哪个虚拟地址映射到该物理页框。
- 在查找时，系统必须遍历倒排页表，找到对应虚拟地址的条目。

##### 优缺点：
- **优点**：节省内存，因为倒排页表的大小与物理内存大小成正比，而不是虚拟地址空间。
- **缺点**：查找效率低，需要使用哈希或遍历方式查找虚拟地址对应的物理页框。

### 页表项（Page Table Entry, PTE）

**页表项** 是页表中的每一条记录，包含了与该虚拟页对应的物理页框的地址信息以及一些额外的控制位。典型的页表项结构包括：

1. **物理页框号（Physical Page Frame Number, PFN）**：
   - 虚拟页映射到的物理内存页框的编号，用于形成物理地址。
   
2. **有效位（Valid Bit）**：
   - 指示该页是否在物理内存中。如果无效，可能需要触发页错误（Page Fault）将页从磁盘加载到内存。

3. **访问位（Accessed Bit）**：
   - 指示该页是否被访问过（读或写）。用于操作系统优化页面调度。

4. **脏位（Dirty Bit）**：
   - 指示该页是否被修改过。如果设置为脏，则在替换该页之前，需要将其写回磁盘。

5. **权限位（Permission Bits）**：
   - 决定该页是否可读、可写或可执行，防止程序非法操作。

6. **页表属性**：
   - 一些高级操作系统和处理器可能包含额外的控制位，如缓存策略、页面大小、特权级等。

### 地址转换流程示意

1. **虚拟地址分解**：
   - 假设虚拟地址为 `0xABCDEF01`，其中 `0xABC` 是页表索引，`0xDEF` 是二级页表索引，`0x01` 是页内偏移量。
   
2. **一级页表查找**：
   - 使用 `0xABC` 作为一级页表索引，找到一级页表中的条目。

3. **二级页表查找**：
   - 根据一级页表的结果，找到二级页表，使用 `0xDEF` 作为索引查找二级页表的条目。

4. **形成物理地址**：
   - 最终通过页表查找得到物理页框号，将其与页内偏移量 `0x01` 结合，形成完整的物理地址。

### TLB（Translation Lookaside Buffer）——加速页表查找

由于页表查找涉及多次内存访问，会增加内存访问延迟。为了解决这个问题，现代处理器中引入了**TLB（Translation Lookaside Buffer）**，它是一个小型、快速的缓存，用于存储最近的页表映射结果。当 CPU 访问某个虚拟地址时，首先查找 TLB，如果命中，便可立即得到对应的物理地址。如果未命中，再去查页表。

- **TLB 命中率高**，因为程序的访问往往具有局部性，大部分地址转换请求可以通过 TLB 缓存满足。
- **TLB 缺失**：当 TLB缺失时，CPU 会根据页表查找得到映射，并将结果存入 TLB，以便后续访问加速。

### 总结

- **页表** 是虚拟内存管理中的核心数据结构，负责将虚拟地址映射到物理地址。不同的页表结构（如单级、多级和倒排页表）平衡了性能和内存开销。
- **页表项** 包含虚拟页与物理页框的映射关系及其他控制信息，如有效位、脏位和权限位。
- 现代处理器使用 **TLB** 来加速页表查找，提高内存访问效率。